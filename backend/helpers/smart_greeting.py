# helpers/smart_greeting.py
import logging
from datetime import datetime

logger = logging.getLogger(__name__)

def get_greeting(user_data):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–º–Ω–æ–µ, –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ.
    """
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–º –ø–µ—Ä–µ–¥–∞–ª–∏
        user_name = user_data.get('first_name', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')

        # 1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
        hour = datetime.now().hour
        if 5 <= hour < 12:
            time_greeting = f"–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, {user_name}! ‚òÄÔ∏è"
        elif 12 <= hour < 18:
            time_greeting = f"–î–æ–±—Ä—ã–π –¥–µ–Ω—å, {user_name}! ‚òïÔ∏è"
        else:
            time_greeting = f"–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä, {user_name}! üåô"

        # 2. –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
        # –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∞–Ω–∞–ª–∏–∑ –∑–∞–¥–∞—á/—Å–æ–±—ã—Ç–∏–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
        proactive_suggestion = "–ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å. <b>–ß—Ç–æ –ø–ª–∞–Ω–∏—Ä—É–µ–º —Å–µ–≥–æ–¥–Ω—è ‚Äî –∑–∞–¥–∞—á–∏, –≤—Å—Ç—Ä–µ—á–∏, –ø—Ä–∏–≤—ã—á–∫–∏?</b>"

        return f"{time_greeting}\n\n{proactive_suggestion}"

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ get_greeting: {e}", exc_info=True)
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ —Å–ª—É—á–∞–µ –ª—é–±–æ–π –æ—à–∏–±–∫–∏
        return f"–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {user_data.get('first_name', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}!"